# シナリオ: codebuild_secrets

**サイズ:** 大

**難しさ:** 難しい

**コマンド:** `$ ./cloudgoat.py create codebuild_secrets`

## シナリオリソース

1 CodeBuild Project

1 Lambda function

1 VPC with:
  * RDS x 1
  * EC2 x 1

2 IAM Users

## 最初の情報

IAM User "Solo"

## シナリオの目的

セキュアなRDSデータベース内のシークレット文字列

## 要約

アタッカーはIAMユーザーのSoloとなり、CodeBuildプロジェクトを探索し、IAMユーザーのCalrissianのIAMキーが保護されていないことを見つけます。Calrissianになりすまし、RDSデータベースを見つけます。データベースの内容に直接はアクセスできませんが、RDSのスナップショット機能を使うことでシナリオの目的であるシークレット文字列を手に入れることができます。

もしくは、SSMパラメータを調査することでEC2インスタンスへのSSHキーを手に入れることができます。メタデータサービスを使い、EC2インスタンスプロファイルキーを手に入れ、より深く入り込み、元のデータベースへアクセスをしシナリオの目的であるシークレット文字列を手に入れます。

Note: このシナリオでは自身でAWSリソースを作ることが想定されますが、CloudGoatはCloudGoat自身がさくせしたリソースのみが管理対象となるため、`./cloudgoat destroy`コマンドを実行する前に自身のリソースは削除してください。

## 攻撃経路

![Scenario Route(s)](https://www.lucidchart.com/publicSegments/view/3580abff-ea55-4719-a368-8618f8b61370/image.png)

## ガイド - CalrissianとRDSスナップショット

1. IAMユーザのSoloとしてアタッカーが調査をすると、CodeBuildプロジェクトを一覧できることを発見します。
2. CodeBuildプロジェクトの中で、アタッカーは"Calrissian"ユーザのIAMキーを環境変数の中で発見します。
3. Calrissianユーザを装い、アタッカーはRDSインスタンスを一覧し、シナリオの目的であるプライベートデータベースを発見します。
4. アタッカーは、RDSインスタンスに直接アクセスできないものの、スナップショットを取ることに成功します。
5. アタッカーはスナップショットからRDSインスタンスを作成します。
6. 新しく作成されたRDSインスタンスのアドミンパスワードをリセットすることで、アタッカーは内容にアクセスできるようになります。
7. リストアされたRDSデータベースにログインすることで、アタッカーはシナリオの目的であるシークレット文字列を手に入れます！

この方法のチートシートは[こちら](./cheat_sheet_calrissian.md).

## ガイド - SoloとEC2メタデータサービス

1. IAMユーザのSoloとしてアタッカーがAWS環境を調査をすると、SSMパラメータを一覧できることを発見します。
2. アカウントのSSMパラメータの中で、暗号化されていないSSHキーペアを発見します。
3. アタッカーは見つけたSSHキーが使えるところを探すためにEC2インスタンスを一覧します。
4. アカウントの中にEC2インスタンスを見つけ、アタッカーはEC2インスタンスへの接続に成功します。

**分岐 A**

1. Shellアクセスを使い、アタッカーはEC2メタデータサービスにクエリを投げ、インスタンスプロファイルのIAMキーを発見します。
2. EC2インスタンスのプロファイルを使い、アタッカーはLambdaを一覧することができます。
3. アタッカーはLambdaの環境変数の中にRDSデータベースのアドミン情報が保護されない状態であるのを発見します。
4. EC2インスタンスのプロファイルのままで、アタッカーはRDSデータベースを一覧、接続し、発見したアドミン情報でログインします。
5. RDSデータベースへのフルアクセスを手に入れ、アタッカーはシナリオの目的であるシークレット文字列を回収できます！

**分岐 B**

1. Shellアクセスを使い、アタッカーはEC2メタデータサービスにクエリを投げ、アドミン情報と一緒にデータベースのアドレスを発見します。
2. EC2メタデータサービスから取得したRDSアドレスとユーザ情報を使い、アタッカーは直接RDSデータベースに直接ログインできます。
3. RDSデータベースへのフルアクセスを手に入れ、アタッカーはシナリオの目的であるシークレット文字列を回収できます！

この方法のチートシートは[こちら](./cheat_sheet_solo.md).